# name: test/sql/cleanup/cleanup_old_files.test
# description: Cleanup files when creating and dropping a table
# group: [cleanup]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/cleanup_old_files', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

statement ok
USE ducklake;

statement ok
CREATE TABLE t (x INT);

statement ok
INSERT INTO t VALUES (1), (2), (3);

statement ok
INSERT INTO t VALUES (4), (5);

statement ok
DELETE FROM t WHERE x <= 2;

statement ok
INSERT INTO t VALUES (6), (7);

statement ok
CALL ducklake_rewrite_data_files('ducklake', 't');

statement ok
CALL ducklake_merge_adjacent_files('ducklake');

statement ok
CALL ducklake_expire_snapshots('ducklake', older_than => now());

query I
SELECT COUNT(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true, cleanup_all => true);
----
2

statement ok
CALL ducklake_cleanup_old_files('ducklake', dry_run => false, cleanup_all => true);

query I
SELECT COUNT(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true, cleanup_all => true);
----
0