# name: test/sql/compaction/expire_snapshot_global_option.test
# description: Test global options for the inlining function ducklake_expire_snapshots
# group: [compaction]

require ducklake

require parquet

require icu

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/expire_snapshot_global_option', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

# delete all values in a table
# snapshot 2
statement ok
CREATE TABLE ducklake.test(i INTEGER)

# snapshot 3
statement ok
INSERT INTO ducklake.test FROM range(10)

statement ok
CALL ducklake.set_option('expire_older_than', '1 millisecond')

query I
SELECT count(*) FROM ducklake_expire_snapshots('ducklake', dry_run => true)
----
3

statement ok
CALL ducklake.set_option('expire_older_than', '1 week')

query I
SELECT count(*) FROM ducklake_expire_snapshots('ducklake', dry_run => true)
----
0

query I
SELECT count(*) FROM ducklake_expire_snapshots('ducklake', dry_run => true, versions => [2])
----
1
