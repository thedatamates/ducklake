# name: test/sql/compaction/cleanup_old_files_global_option.test
# description: Test global options for the cleanup old files function ducklake_cleanup_old_files
# group: [compaction]

require ducklake

require parquet

require icu

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/cleanup_old_files_global_option', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

# snapshot 2
statement ok
CREATE TABLE ducklake.test(i INTEGER)

# snapshot 3
statement ok
INSERT INTO ducklake.test FROM range(1000)

# snapshot 4
statement ok
DELETE FROM ducklake.test

# snapshot 5
statement ok
DROP TABLE ducklake.test

statement ok
CALL ducklake_expire_snapshots('ducklake', dry_run => false, versions => [3])

statement ok
CALL ducklake.set_option('delete_older_than', '1 millisecond')

query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true)
----
1

statement ok
CALL ducklake.set_option('delete_older_than', '1 week')

query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true)
----
0

query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true, cleanup_all => true)
----
1

