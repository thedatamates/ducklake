# name: test/sql/multi_catalog/catalog_isolation.test
# description: test that multiple catalogs with different catalog names are isolated
# group: [multi_catalog]

require ducklake

require parquet

test-env DATA_PATH __TEST_DIR__

# Test catalog isolation with separate metadata databases
# (shared metadata requires a server-based database like PostgreSQL)

# First catalog with catalog name 'tenant_a'
statement ok
ATTACH 'ducklake:__TEST_DIR__/tenant_a_meta.db' AS tenant_a (DATA_PATH '${DATA_PATH}/tenant_a', CATALOG 'tenant_a', CREATE_IF_NOT_EXISTS true);

statement ok
USE tenant_a;

statement ok
CREATE TABLE users (id INT, name VARCHAR);

statement ok
INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob');

# Verify data in tenant_a
query II
SELECT * FROM users ORDER BY id;
----
1	Alice
2	Bob

# Second catalog with catalog name 'tenant_b' (separate metadata database)
statement ok
ATTACH 'ducklake:__TEST_DIR__/tenant_b_meta.db' AS tenant_b (DATA_PATH '${DATA_PATH}/tenant_b', CATALOG 'tenant_b', CREATE_IF_NOT_EXISTS true);

statement ok
USE tenant_b;

# This should be empty - tenant_b has no tables yet
statement error
SELECT * FROM users;
----
Table with name users does not exist!

# Create different data in tenant_b
statement ok
CREATE TABLE users (id INT, name VARCHAR);

statement ok
INSERT INTO users VALUES (100, 'Xavier'), (200, 'Yuki'), (300, 'Zara');

# Verify tenant_b sees its own data
query II
SELECT * FROM users ORDER BY id;
----
100	Xavier
200	Yuki
300	Zara

# Go back to tenant_a and verify its data is unchanged
statement ok
USE tenant_a;

# tenant_a should still have its original data
query II
SELECT * FROM users ORDER BY id;
----
1	Alice
2	Bob

# Verify the count is correct
query I
SELECT COUNT(*) FROM users;
----
2

# Verify each catalog has its own metadata database (separate files = separate metadata)
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name LIKE '__ducklake_metadata_%';
----
2

# Clean up
statement ok
USE memory;

statement ok
DETACH tenant_a;

statement ok
DETACH tenant_b;
