# name: test/sql/macros/test_macro_multiple_connections.test
# description: test macros are transaction safe over multiple connections
# group: [macros]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/test_macro_multiple_connections', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

statement ok
USE ducklake

statement ok con1
USE ducklake

statement ok con2
USE ducklake

# two transactions try to create a macro conflict

statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
CREATE MACRO add_one(x INTEGER) AS (x + 1);

statement ok con2
CREATE MACRO add_one(x INTEGER) AS (x + 1);

statement ok con1
COMMIT

statement error con2
COMMIT
----
conflict

# two transactions try to drop a macro: conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
DROP MACRO add_one;

statement ok con2
DROP MACRO add_one;

statement ok con1
COMMIT

statement error con2
COMMIT
----
conflict

statement ok
CREATE TABLE test_tbl (id INT, name string);


# Doing a scalar and table macro on different transactions should be ok
statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
CREATE MACRO gimme_one() AS 1;

statement ok con2
CREATE MACRO gimme_one() as TABLE SELECT * FROM test_tbl LIMIT 1;

statement ok con1
COMMIT

statement ok con2
COMMIT


# Two transactions trying to drop same macro table should fail
statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
DROP MACRO TABLE gimme_one;

statement ok con2
DROP MACRO TABLE gimme_one;

statement ok con1
COMMIT

statement error con2
COMMIT
----
conflict
