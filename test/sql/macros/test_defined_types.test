# name: test/sql/macros/test_defined_types.test
# description: test macro where types are explicitly user-defined
# group: [macros]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/test_defined_types');

statement ok
USE ducklake;

statement ok
CREATE MACRO add_one(x INTEGER) AS (x + 1);

# Check Macro Tables
query IIIIII
FROM __ducklake_metadata_ducklake.ducklake_macro;
----
0	1	add_one	1	NULL	(empty)

query IIIII
FROM __ducklake_metadata_ducklake.ducklake_macro_impl;
----
1	0	duckdb	(x + 1)	scalar

query IIIIIII
FROM __ducklake_metadata_ducklake.ducklake_macro_parameters;
----
1	0	0	x	int32	NULL	unknown

query I
select add_one(1)
----
2


# Check with default parameter and defined type on different parameters
statement ok
CREATE MACRO add_two_def(x INTEGER, y := 5) AS (x + y);

# Check Macro Tables
query IIIIII
FROM __ducklake_metadata_ducklake.ducklake_macro;
----
0	1	add_one	1	NULL	(empty)
0	2	add_two_def	2	NULL	(empty)

query IIIII
FROM __ducklake_metadata_ducklake.ducklake_macro_impl;
----
1	0	duckdb	(x + 1)	scalar
2	0	duckdb	(x + y)	scalar

query IIIIIII
FROM __ducklake_metadata_ducklake.ducklake_macro_parameters;
----
1	0	0	x	int32	NULL	unknown
2	0	0	x	int32	NULL	unknown
2	0	1	y	unknown	5	int32

query I
select add_two_def(1)
----
6

# Check with default parameter and defined type on same parameters

statement ok
CREATE MACRO add_one_same(x BIGINT := 1) AS (x + 1);

# Check Macro Tables
query IIIIII
FROM __ducklake_metadata_ducklake.ducklake_macro;
----
0	1	add_one	1	NULL	(empty)
0	2	add_two_def	2	NULL	(empty)
0	3	add_one_same	3	NULL	(empty)

query IIIII
FROM __ducklake_metadata_ducklake.ducklake_macro_impl;
----
1	0	duckdb	(x + 1)	scalar
2	0	duckdb	(x + y)	scalar
3	0	duckdb	(x + 1)	scalar

query IIIIIII
FROM __ducklake_metadata_ducklake.ducklake_macro_parameters;
----
1	0	0	x	int32	NULL	unknown
2	0	0	x	int32	NULL	unknown
2	0	1	y	unknown	5	int32
3	0	0	x	int64	1	int32

query I
select add_two_def(1)
----
6

