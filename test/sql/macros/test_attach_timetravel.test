# name: test/sql/macros/test_attach_timetravel.test
# description: test attach timetravel
# group: [macros]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/test_attach_timetravel.db' AS ducklake (DATA_PATH '__TEST_DIR__/test_attach_timetravel', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

statement ok
use ducklake

statement ok
CREATE MACRO simple(a) AS a;

statement ok
DROP MACRO simple

query II
select snapshot_id, changes FROM snapshots()
----
0	{}
1	{schemas_created=[main]}
2	{scalar_macros_created=['main."simple"']}
3	{scalar_macros_dropped=[2]}

statement error
select simple(1)
----
Scalar Function with name simple does not exist!

statement ok
USE memory

statement ok
DETACH ducklake

statement ok
ATTACH 'ducklake:__TEST_DIR__/test_attach_timetravel.db' AS ducklake (DATA_PATH '__TEST_DIR__/test_attach_timetravel', SNAPSHOT_VERSION 2, CATALOG 'test', CREATE_IF_NOT_EXISTS true);

statement ok
use ducklake

query I
select simple(1)
----
1
