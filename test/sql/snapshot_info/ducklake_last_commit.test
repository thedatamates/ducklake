# name: test/sql/snapshot_info/ducklake_last_commit.test
# description: test that the ducklake_last_commit_snapshot returns last committed snapshot id
# group: [snapshot_info]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_last_snapshot_commit.db' AS ducklake (CATALOG 'test');

query I
FROM ducklake_last_committed_snapshot('ducklake')
----
NULL

# Snapshot 1
statement ok
CREATE TABLE ducklake.integer(i INTEGER);

query I
FROM ducklake_last_committed_snapshot('ducklake')
----
1

# Start a few transactions
statement ok con1
BEGIN TRANSACTION

statement ok con2
BEGIN TRANSACTION

statement ok con3
BEGIN TRANSACTION

# Each transaction does somethins
statement ok con1
CREATE TABLE ducklake.integers_2(i INTEGER)

statement ok con1
INSERT into ducklake.integers_2 values (0);

statement ok con2
INSERT into ducklake.integer values (0);

statement ok con3
INSERT into ducklake.integer  values (1);

# Snapshot still 1
query I
FROM ducklake_last_committed_snapshot('ducklake')
----
1

# Check commited snapshot from within a transaction
query I con1
FROM ducklake_last_committed_snapshot('ducklake')
----
1

statement ok con1
COMMIT

query I
FROM ducklake_last_committed_snapshot('ducklake')
----
2

statement ok con2
ROLLBACK

query I
FROM ducklake_last_committed_snapshot('ducklake')
----
2

statement ok con3
COMMIT

query I
FROM ducklake_last_committed_snapshot('ducklake')
----
3

statement ok
DETACH ducklake

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_last_snapshot_commit.db' AS ducklake (CATALOG 'test');

statement ok
USE ducklake;

# Last snapshot is reset for the transaction
query I
FROM ducklake_last_committed_snapshot('ducklake')
----
NULL

# Try out the macro
query I
FROM last_committed_snapshot()
----
NULL

statement ok
SET ducklake_max_retry_count = 100;


# Try concurrency
concurrentloop i 0 50

skipif i>25
statement ok
insert into ducklake.integer values (${i});

skipif i<25
statement ok
FROM ducklake_last_committed_snapshot('ducklake')

endloop

# 26 + 3
query I
FROM last_committed_snapshot()
----
29