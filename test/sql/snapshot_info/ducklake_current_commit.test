# name: test/sql/snapshot_info/ducklake_current_commit.test
# description: test that the ducklake_current_snapshot returns current snapshot id
# group: [snapshot_info]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_current_snapshot_commit', CATALOG 'test');

statement ok
USE ducklake;

query I
FROM ducklake_current_snapshot('ducklake')
----
1

# Snapshot 2
statement ok
CREATE TABLE integer(i INTEGER);

query I
FROM ducklake_current_snapshot('ducklake')
----
2

# Start a few transactions
statement ok con1
BEGIN TRANSACTION

statement ok con2
BEGIN TRANSACTION

statement ok con3
BEGIN TRANSACTION

# Each transaction does somethins
statement ok con1
CREATE TABLE ducklake.integers_2(i INTEGER)

statement ok con1
INSERT into ducklake.integers_2 values (0);

statement ok con2
INSERT into ducklake.integer values (0);

statement ok con3
INSERT into ducklake.integer  values (1);

# Snapshot still 2
query I
FROM ducklake_current_snapshot('ducklake')
----
2

# Check commited snapshot from within a transaction
query I con1
FROM ducklake_current_snapshot('ducklake')
----
2

statement ok con1
COMMIT

query I
FROM ducklake_current_snapshot('ducklake')
----
3

statement ok con2
ROLLBACK

query I
FROM ducklake_current_snapshot('ducklake')
----
3

statement ok con3
COMMIT

query I
FROM ducklake_current_snapshot('ducklake')
----
4

# Try out the macro
query I
FROM current_snapshot()
----
4