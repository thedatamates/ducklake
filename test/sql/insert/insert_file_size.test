# name: test/sql/insert/insert_file_size.test
# description: test ducklake split up insert across files
# group: [insert]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_insert_file_size', CATALOG 'test')

statement ok
CREATE TABLE ducklake.test(id INTEGER, s VARCHAR);

statement ok
CALL ducklake.set_option('target_file_size', '10KB')

query I
INSERT INTO ducklake.test SELECT i, concat('thisisalongstring', i) FROM range(500000) t(i)
----
500000

# we should be splitting this up into multiple files
query I
SELECT COUNT(*) > 1 FROM glob('${DATA_PATH}/ducklake_insert_file_size/test/main/test/*.parquet')
----
true
