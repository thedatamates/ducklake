# name: test/sql/rewrite_data_files/last_snapshot_multiple_inserts.test
# description: Test deletion works over a series of insertions and deletions
# group: [rewrite_data_files]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_multiple_inserts', METADATA_CATALOG 'ducklake_metadata', CATALOG 'test')

statement ok
USE ducklake

statement ok
CREATE TABLE test(key INTEGER, values VARCHAR);

# 2	{tables_inserted_into=[1]}
statement ok
INSERT INTO test SELECT i, concat('thisisastring_', i) FROM range(100) t(i)

# Let's do a few insertions interleaved with deletions
# 3	{tables_deleted_from=[1]}
statement ok
DELETE FROM test
WHERE key < 50;

# 4	{tables_inserted_into=[1]}
statement ok
INSERT INTO test SELECT i, concat('thisisastring_', i) FROM range(100,200) t(i)

# 5	{tables_deleted_from=[1]}
statement ok
DELETE FROM test
WHERE key < 80;

# 6	{tables_deleted_from=[1]}
statement ok
DELETE FROM test
WHERE key  = 120;

# 7	{tables_inserted_into=[1]}
statement ok
INSERT INTO test SELECT i, concat('thisisastring_', i) FROM range(200,300) t(i)

# 8	{tables_deleted_from=[1]}
statement ok
DELETE FROM test
WHERE key  > 200 and key < 250;

query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_multiple_inserts/**/*')
----
7

statement ok
CALL ducklake_rewrite_data_files('ducklake', 'test', delete_threshold => 0);

statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

# Add one Remove one, same stuff
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_multiple_inserts/**/*')
----
7

query I
select count(*) from test;
----
170

# Test previous snapshots are all-right
query II
SELECT snapshot_id, changes FROM snapshots();
----
0	{schemas_created=[main]}
1	{tables_created=[main.test]}
2	{tables_inserted_into=[2]}
3	{tables_deleted_from=[2]}
4	{tables_inserted_into=[2]}
5	{tables_deleted_from=[2]}
6	{tables_deleted_from=[2]}
7	{tables_inserted_into=[2]}
8	{tables_deleted_from=[2]}
9	{}

loop i 0 2

query I
select count(*) from test AT (VERSION => 3);
----
50

query I
select count(*) from test AT (VERSION => 4);
----
150

query I
select count(*) from test AT (VERSION => 5);
----
120

query I
select count(*) from test AT (VERSION => 6);
----
119

query I
select count(*) from test AT (VERSION => 7);
----
219

query I
select count(*) from test AT (VERSION => 8);
----
170

statement ok
CALL ducklake_rewrite_data_files('ducklake', 'test', delete_threshold => 0);

statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

endloop