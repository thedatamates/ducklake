# name: test/sql/rewrite_data_files/test_rewrite_merge_adjacent.test
# description: Test calling rewrite and merge adjacent
# group: [rewrite_data_files]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/test_rewrite_merge_adjacent/', METADATA_CATALOG 'test_rewrite_merge_adjacent', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

statement ok
USE ducklake;

statement ok
CREATE TABLE t (a VARCHAR, b INT);

# Generates the 1st file
statement ok
INSERT INTO t VALUES ('text', 1);

# Generates the 2nd file
statement ok
INSERT INTO t VALUES ('text2', 2);

# Generates the 3rd file
statement ok
INSERT INTO t SELECT 'text' a, range b FROM range(100_000);

# Deletes on the 3rd file
statement ok
DELETE FROM t WHERE b > 100;

# Rewrites 3rd file
statement ok
CALL ducklake_rewrite_data_files('ducklake', 't');

# Should merge everyone
statement ok
CALL ducklake_merge_adjacent_files('ducklake');

query I
SELECT COUNT(*) FROM ducklake_list_files('ducklake', 't');
----
1
