# name: test/sql/geo/ducklake_geometry_merge.test
# group: [geo]

require ducklake

require parquet

require spatial

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_files', METADATA_CATALOG 'ducklake_meta', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

statement ok
USE ducklake;

statement ok
create table t1 (i INT, g GEOMETRY);

statement ok
insert into t1 VALUES (1, ST_POINT(1,2));

query II
select * from t1;
----
1	POINT (1 2)

# Merge into
statement ok
MERGE INTO t1 USING
 	(SELECT 1 as i, 'LINESTRING Z (5 5 5, 10 10 10)'::GEOMETRY AS g) AS src
	ON t1.i = src.i
	WHEN MATCHED THEN UPDATE
	WHEN NOT MATCHED THEN INSERT;

query II
select * from t1;
----
1	LINESTRING Z (5 5 5, 10 10 10)

# Normal update
statement ok
UPDATE t1 SET g = ST_POINT(3,4) WHERE i = 1;

query II
select * from t1;
----
1	POINT (3 4)

# Also test with an alter table
statement ok
ALTER TABLE t1 ADD COLUMN g2 geometry;

statement ok
UPDATE t1 SET g2 = ST_POINT(7,8) WHERE i = 1

query III
select * from t1;
----
1	POINT (3 4)	POINT (7 8)
