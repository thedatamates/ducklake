# name: test/sql/fork/fork_if_not_exists.test
# description: test if_not_exists option for ducklake_fork_catalog
# group: [fork]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/fork_ine_meta.db' AS parent_catalog (DATA_PATH '__TEST_DIR__/fork_ine_data', CATALOG 'parent');

statement ok
USE parent_catalog;

statement ok
CREATE TABLE users (id INT, name VARCHAR);

statement ok
INSERT INTO users VALUES (1, 'Alice');

# Test 1: First fork without if_not_exists - should create, return created=true (1)
query TI
SELECT catalog_name, created::INT FROM ducklake_fork_catalog('parent_catalog', 'forked');
----
forked	1

# Verify catalog exists
query T
SELECT catalog_name FROM ducklake_catalogs('parent_catalog') WHERE catalog_name = 'forked';
----
forked

# Test 2: Second fork with same name WITHOUT if_not_exists - should error
statement error
SELECT * FROM ducklake_fork_catalog('parent_catalog', 'forked');
----
already exists

# Test 3: Second fork with same name WITH if_not_exists - should return existing with created=false (0)
query TI
SELECT catalog_name, created::INT FROM ducklake_fork_catalog('parent_catalog', 'forked', if_not_exists := true);
----
forked	0

# Test 4: Third fork with different name and if_not_exists - should create new
query TI
SELECT catalog_name, created::INT FROM ducklake_fork_catalog('parent_catalog', 'forked2', if_not_exists := true);
----
forked2	1

# Verify all three catalogs exist
query T
SELECT catalog_name FROM ducklake_catalogs('parent_catalog') ORDER BY catalog_name;
----
forked
forked2
parent

# Test 5: Try to fork with if_not_exists for existing catalog but from different parent
# First create a new root catalog by attaching with a different name
statement ok
USE memory;

statement ok
DETACH parent_catalog;

# Re-attach to access forked catalog
statement ok
ATTACH 'ducklake:__TEST_DIR__/fork_ine_meta.db' AS forked_catalog (DATA_PATH '__TEST_DIR__/fork_ine_data', CATALOG 'forked');

# Create a fork from forked_catalog
query TI
SELECT catalog_name, created::INT FROM ducklake_fork_catalog('forked_catalog', 'child_of_forked');
----
child_of_forked	1

# Now try to get 'child_of_forked' with if_not_exists but from parent (should fail - different parent)
statement ok
DETACH forked_catalog;

statement ok
ATTACH 'ducklake:__TEST_DIR__/fork_ine_meta.db' AS parent_catalog (DATA_PATH '__TEST_DIR__/fork_ine_data', CATALOG 'parent');

statement error
SELECT * FROM ducklake_fork_catalog('parent_catalog', 'child_of_forked', if_not_exists := true);
----
forked from a different parent

# Test 6: Try to use if_not_exists on a root catalog name (should fail - not a fork)
statement error
SELECT * FROM ducklake_fork_catalog('parent_catalog', 'parent', if_not_exists := true);
----
not a fork

statement ok
USE memory;

statement ok
DETACH parent_catalog;
