# name: test/sql/fork/fork_isolation.test
# description: test that forked catalogs are isolated from parent
# group: [fork]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/isolation_meta.db' AS parent (DATA_PATH '__TEST_DIR__/isolation_data', CATALOG 'parent');

statement ok
USE parent;

statement ok
CREATE TABLE products (id INT, name VARCHAR, price DECIMAL(10,2));

statement ok
INSERT INTO products VALUES (1, 'Widget', 10.00), (2, 'Gadget', 20.00);

query III
SELECT * FROM products ORDER BY id;
----
1	Widget	10.00
2	Gadget	20.00

statement ok
SELECT * FROM ducklake_fork_catalog('parent', 'child');

statement ok
USE memory;

statement ok
DETACH parent;

statement ok
ATTACH 'ducklake:__TEST_DIR__/isolation_meta.db' AS child (DATA_PATH '__TEST_DIR__/isolation_data', CATALOG 'child');

statement ok
USE child;

statement ok
INSERT INTO products VALUES (3, 'Doodad', 30.00);

query III
SELECT * FROM products ORDER BY id;
----
1	Widget	10.00
2	Gadget	20.00
3	Doodad	30.00

statement ok
UPDATE products SET price = 15.00 WHERE id = 1;

query III
SELECT * FROM products ORDER BY id;
----
1	Widget	15.00
2	Gadget	20.00
3	Doodad	30.00

statement ok
DELETE FROM products WHERE id = 2;

query III
SELECT * FROM products ORDER BY id;
----
1	Widget	15.00
3	Doodad	30.00

statement ok
USE memory;

statement ok
DETACH child;

statement ok
ATTACH 'ducklake:__TEST_DIR__/isolation_meta.db' AS parent (DATA_PATH '__TEST_DIR__/isolation_data', CATALOG 'parent');

statement ok
USE parent;

query III
SELECT * FROM products ORDER BY id;
----
1	Widget	10.00
2	Gadget	20.00

statement ok
INSERT INTO products VALUES (4, 'Thingamajig', 40.00);

query III
SELECT * FROM products ORDER BY id;
----
1	Widget	10.00
2	Gadget	20.00
4	Thingamajig	40.00

statement ok
USE memory;

statement ok
DETACH parent;

statement ok
ATTACH 'ducklake:__TEST_DIR__/isolation_meta.db' AS child (DATA_PATH '__TEST_DIR__/isolation_data', CATALOG 'child');

statement ok
USE child;

query III
SELECT * FROM products ORDER BY id;
----
1	Widget	15.00
3	Doodad	30.00

statement ok
USE memory;

statement ok
DETACH child;
