# name: test/sql/fork/basic_fork.test
# description: test basic catalog forking functionality
# group: [fork]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/fork_meta.db' AS parent_catalog (DATA_PATH '__TEST_DIR__/fork_data', CATALOG 'parent', CREATE_IF_NOT_EXISTS true);

statement ok
USE parent_catalog;

statement ok
CREATE TABLE users (id INT, name VARCHAR);

statement ok
INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob'), (3, 'Charlie');

query II
SELECT * FROM users ORDER BY id;
----
1	Alice
2	Bob
3	Charlie

statement ok
CREATE TABLE orders (order_id INT, user_id INT, amount DECIMAL(10,2));

statement ok
INSERT INTO orders VALUES (101, 1, 99.99), (102, 2, 149.50), (103, 1, 25.00);

query III
SELECT * FROM orders ORDER BY order_id;
----
101	1	99.99
102	2	149.50
103	1	25.00

statement ok
SELECT * FROM ducklake_fork_catalog('parent_catalog', 'forked');

statement ok
USE memory;

statement ok
DETACH parent_catalog;

statement ok
ATTACH 'ducklake:__TEST_DIR__/fork_meta.db' AS forked_catalog (DATA_PATH '__TEST_DIR__/fork_data', CATALOG 'forked', CREATE_IF_NOT_EXISTS true);

statement ok
USE forked_catalog;

query II
SELECT * FROM users ORDER BY id;
----
1	Alice
2	Bob
3	Charlie

query III
SELECT * FROM orders ORDER BY order_id;
----
101	1	99.99
102	2	149.50
103	1	25.00

statement ok
INSERT INTO users VALUES (4, 'Diana');

query II
SELECT * FROM users ORDER BY id;
----
1	Alice
2	Bob
3	Charlie
4	Diana

statement ok
USE memory;

statement ok
DETACH forked_catalog;

statement ok
ATTACH 'ducklake:__TEST_DIR__/fork_meta.db' AS parent_catalog (DATA_PATH '__TEST_DIR__/fork_data', CATALOG 'parent', CREATE_IF_NOT_EXISTS true);

statement ok
USE parent_catalog;

query II
SELECT * FROM users ORDER BY id;
----
1	Alice
2	Bob
3	Charlie

statement ok
USE memory;

statement ok
DETACH parent_catalog;
