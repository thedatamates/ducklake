# name: test/sql/merge/merge_into_tpch.test_slow
# description: Test merge into with TPC-H SF1
# group: [merge]

require ducklake

require parquet

require tpch

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_merge_into_tpch_files', METADATA_CATALOG 'ducklake_meta', CATALOG 'test', CREATE_IF_NOT_EXISTS true);

statement ok
CALL dbgen(sf=1);

statement ok
CREATE TABLE ducklake.random_lineitem AS FROM lineitem LIMIT 0

# create lineitem but with a random subset of the rows
statement ok
MERGE INTO ducklake.random_lineitem USING lineitem USING (l_orderkey, l_linenumber)
WHEN NOT MATCHED AND random() < 0.2 THEN INSERT

# insert a bunch of rows with unchanged values
statement ok
MERGE INTO ducklake.random_lineitem USING (SELECT * REPLACE (l_orderkey + 10000000 AS l_orderkey) FROM lineitem) USING (l_orderkey, l_linenumber)
WHEN MATCHED THEN ERROR
WHEN NOT MATCHED AND random() < 0.2 THEN INSERT

# randomly update a bunch of rows
statement ok
MERGE INTO ducklake.random_lineitem USING lineitem USING (l_orderkey, l_linenumber)
WHEN MATCHED AND random() < 0.1 THEN UPDATE SET l_discount = random()

# run two merges that should fully equalize the tables
statement ok
MERGE INTO ducklake.random_lineitem USING lineitem USING (l_orderkey, l_linenumber)
WHEN MATCHED THEN UPDATE

statement ok
MERGE INTO ducklake.random_lineitem USING lineitem USING (l_orderkey, l_linenumber)
WHEN NOT MATCHED BY TARGET THEN INSERT
WHEN NOT MATCHED BY SOURCE THEN DELETE

# both tables should now be identical - despite all the random stuff we did
query IIIIIIIIIIIIIIII
FROM lineitem EXCEPT FROM ducklake.random_lineitem
----

query IIIIIIIIIIIIIIII
FROM ducklake.random_lineitem EXCEPT FROM lineitem
----

statement ok
DROP TABLE ducklake.random_lineitem
